# Caching configuration for VOXAR nginx

# Static assets caching
location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header X-Cache-Status "HIT";
    
    # Enable gzip for static files
    gzip_static on;
    
    # CORS for web fonts
    if ($request_filename ~* \.(woff|woff2|ttf|eot)$) {
        add_header Access-Control-Allow-Origin "*";
    }
}

# HTML caching
location ~* \.(html|htm)$ {
    expires 1h;
    add_header Cache-Control "public, must-revalidate";
}

# API response caching
location ~ ^/api/(config|metadata|public) {
    proxy_cache api_cache;
    proxy_cache_valid 200 5m;
    proxy_cache_valid 404 1m;
    proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
    proxy_cache_background_update on;
    proxy_cache_lock on;
    add_header X-Cache-Status $upstream_cache_status;
}

# Health check responses (no cache)
location ~ ^/(health|metrics|status) {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
}

# WebSocket connections (no cache)
location ~ ^/(ws|websocket) {
    proxy_buffering off;
    proxy_cache off;
}